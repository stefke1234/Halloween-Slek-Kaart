<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Halloween Slek Kaart</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body {
  height:100%; margin:0; padding:0; font-family:"Creepster", cursive, Arial, sans-serif;
  background:#1a1a1a; color:#fff;
}
header {
  width:100%; text-align:center; padding:10px;
  background: linear-gradient(90deg,#ff6600,#cc3300);
  color:white; font-size:1.5rem; font-weight:bold;
  text-shadow:0 0 8px black,0 0 12px #ff6600;
  border-bottom:3px solid black;
  box-sizing:border-box;
}
#map {
  position:absolute;
  top:70px; bottom:0; left:0; right:0;
  border:6px solid #ff6600; border-radius:20px;
  box-shadow:0 0 20px #ff6600, 0 0 40px #660000;
  z-index:1;
}
.leaflet-popup-content-wrapper {
  background-color: rgba(0,0,0,0.85); color:orange; font-weight:bold;
  border-radius:10px; border:2px solid #ff6600; text-align:center;
}
@keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }
.pulse-icon { animation: pulse 1.2s infinite; }

#resetButton {
  position:absolute; top:35px; left:10px; z-index:3000;
  background:#ff6600; color:white; border:2px solid black;
  padding:5px 10px; border-radius:6px; font-weight:bold; cursor:pointer;
}
.leaflet-control-follow {
  background:#ff6600; color:white; padding:5px 10px;
  cursor:pointer; font-weight:bold; border:2px solid black;
  border-radius:6px; user-select:none; z-index:3000;
}

.user-marker { filter: brightness(0) saturate(100%); }
</style>
</head>
<body>

<header>🎃 Halloween Tocht Slek 🎃</header>
<button id="resetButton" onclick="resetHuizen()">Reset Huizen</button>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Instellingen ---
var followZoom = 16.5;
var withinRadiusMeters = 20;

// --- Kaart ---
var map = L.map('map').setView([52.0000,5.0002], followZoom);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'© OpenStreetMap contributors'
}).addTo(map);

// --- Huizen ---
var huizen = [
  {id:1, lat:52.0000, lon:5.0002, activiteit:"Pompoen snijden"},
  {id:2, lat:52.00005, lon:5.00025, activiteit:"Spooktocht"},
  {id:3, lat:51.99995, lon:5.00015, activiteit:"Trick or Treat"}
];

var halloweenActiveIcon = L.icon({iconUrl:'pumpkin_active.png', iconSize:[32,32], iconAnchor:[16,32]});
var halloweenVisitedIcon = L.icon({iconUrl:'pumpkin_visited.png', iconSize:[32,32], iconAnchor:[16,32]});

// Maak markers
huizen.forEach(function(huis){
  var visited = localStorage.getItem('huis_'+huis.id) === 'true';
  huis.marker = L.marker([huis.lat, huis.lon], {icon: visited ? halloweenVisitedIcon : halloweenActiveIcon})
                .addTo(map).bindPopup(huis.activiteit);
});

// --- User marker ---
var userMarker;
var userIcon = L.icon({iconUrl:'user.png', iconSize:[48,64], iconAnchor:[24,64], className:'user-marker'});

// --- Visuele cirkel ---
var userCircle = L.circle([0,0], {
  radius:withinRadiusMeters,
  color:'orange',
  fillColor:'rgba(255,165,0,0.15)',
  weight:2
}).addTo(map);

// --- Volg-knop ---
var isFollowing = true;
var followMe = L.control({position:'topright'});
followMe.onAdd = function(map){
  var div = L.DomUtil.create('div','leaflet-control-follow');
  div.innerHTML='📍 Volg mij';
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.on(div,'click',function(e){
    L.DomEvent.stopPropagation(e);
    L.DomEvent.preventDefault(e);
    isFollowing = !isFollowing;
    div.style.background = isFollowing ? '#ff6600' : '#555';
    if(isFollowing && userMarker){
      map.flyTo(userMarker.getLatLng(), followZoom,{animate:true,duration:0.8});
    }
  });
  return div;
};
followMe.addTo(map);

// --- Reset functie ---
function resetHuizen(){
  huizen.forEach(h=>localStorage.removeItem('huis_'+h.id));
  alert("Huizen gereset!");
  location.reload(); // veilig herladen zodat alles correct zichtbaar is
}

// --- Locatie volgen ---
map.locate({setView:false, watch:true, enableHighAccuracy:true});
var firstFix = true;

function onLocationFound(e){
  var latlng = e.latlng;

  if(!userMarker){
    userMarker = L.marker(latlng, {icon:userIcon}).addTo(map).bindPopup("Jij bent hier!");
  } else {
    userMarker.setLatLng(latlng);
  }
  userCircle.setLatLng(latlng);

  if(firstFix){
    map.flyTo(latlng, followZoom, {animate:true,duration:0.8});
    firstFix=false;
  } else if(isFollowing){
    map.flyTo(latlng, followZoom, {animate:true,duration:0.8});
  }

  // Check huizen
  huizen.forEach(function(huis){
    var afstand = map.distance(latlng,[huis.lat,huis.lon]);
    var visited = localStorage.getItem('huis_'+huis.id)==='true';
    if(afstand<withinRadiusMeters && !visited){
      huis.marker.setIcon(halloweenVisitedIcon);
      localStorage.setItem('huis_'+huis.id,'true');
    } else {
      huis.marker.setIcon(visited ? halloweenVisitedIcon : halloweenActiveIcon);
    }
  });
}

function onLocationError(e){
  alert("Kan je locatie niet vinden: "+e.message);
}

map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes" />
<title>Halloween Slek Kaart</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
html, body {
  height:100%; margin:0; padding:0;
  background:#1a1a1a; font-family:"Creepster", cursive, Arial, sans-serif;
  color:#fff; overflow:hidden;
}
header {
  text-align:center; padding:10px;
  background: linear-gradient(90deg,#ff6600,#cc3300);
  color:white; font-size:1.5rem; font-weight:bold;
  text-shadow:0 0 8px black,0 0 12px #ff6600;
  border-bottom:3px solid black; position:relative; z-index:1000;
}
#map {
  position:absolute;
  top:100px; /* ruimte voor header en knoppen */
  left:0; right:0; bottom:0;
  border:6px solid #ff6600; border-radius:20px;
  box-shadow:0 0 20px #ff6600,0 0 40px #660000;
  z-index:1;
}
.leaflet-popup-content-wrapper {
  background-color: rgba(0,0,0,0.85); color:orange; font-weight:bold;
  border-radius:10px; border:2px solid #ff6600; text-align:center;
}
@keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }
.pulse-icon { animation: pulse 1.2s infinite; }

.decoratie { position:absolute; z-index:2000; width:60px; opacity:0.85; }
.decoratie.topleft { top:100px; left:5px; transform:rotate(-15deg); }
.decoratie.topright { top:100px; right:5px; transform:rotate(15deg); }
.decoratie.bottomleft { bottom:15px; left:5px; }
.decoratie.bottomright { bottom:15px; right:5px; }

.leaflet-control-follow {
  background:#ff6600; color:white; padding:5px 10px;
  cursor:pointer; font-weight:bold; border:2px solid black;
  border-radius:6px; user-select:none; z-index:3000;
}

#resetButton {
  position:absolute; top:60px; left:10px; z-index:3000;
  background:#ff6600; color:white; border:2px solid black;
  padding:5px 10px; border-radius:6px; font-weight:bold; cursor:pointer;
}

.leaflet-control { z-index:3000 !important; } /* Zorg dat controls boven decoratie blijven */

/* Maak user icon altijd zwart */
.user-marker {
  filter: brightness(0) saturate(100%);
}
</style>
</head>
<body>
<header>🎃 Halloween Tocht Slek 🎃</header>

<button id="resetButton" onclick="resetHuizen()">Reset Huizen</button>

<div id="map"></div>

<!-- Decoratie -->
<img src="bat.png" class="decoratie topleft" alt="Vleermuis">
<img src="web.png" class="decoratie topright" alt="Spinnenweb">
<img src="bat.png" class="decoratie bottomleft" alt="Vleermuis">
<img src="web.png" class="decoratie bottomright" alt="Spinnenweb">

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// --- Instellingen ---
var followZoom = 16.5;
var withinRadiusMeters = 20;

// --- Kaart ---
var map = L.map('map').setView([51.0871502072908, 5.883705289954999], 16.5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

// --- Huizen ---
var huizen = [
      {id:1, lat:51.08915177801586, lon:5.886047856448435, activiteit:"Pompoen snijden"},
      {id:2, lat:51.08712549370868, lon:5.887171622260087, activiteit:"Spooktocht"},
      {id:3, lat:51.091792299924435, lon:5.884509115831604, activiteit:"Trick or Treat"}
      {id:4, lat:51.08738143818212, lon:5.885281178365299, activiteit:"Trick or Treat"}
];

var halloweenActiveIcon = L.icon({iconUrl:'pumpkin_active.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]});
var halloweenVisitedIcon = L.icon({iconUrl:'pumpkin_visited.png', iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]});

// Maak markers
huizen.forEach(function(huis){
  var visited = localStorage.getItem('huis_'+huis.id) === 'true';
  var iconToUse = visited ? halloweenVisitedIcon : halloweenActiveIcon;
  huis.marker = L.marker([huis.lat, huis.lon], {icon: iconToUse}).addTo(map).bindPopup(huis.activiteit);
});

// --- User marker ---
var userMarker;
var userIcon = L.icon({
  iconUrl:'user.png',
  iconSize:[48,64],
  iconAnchor:[24,64],
  popupAnchor:[0,-64],
  className:'user-marker'
});

// --- Visuele cirkel ---
var userCircle = L.circle([0,0], {
  radius: withinRadiusMeters,
  color:'orange',
  fillColor:'rgba(255,165,0,0.15)',
  weight:2
}).addTo(map);

// --- Volg-knop ---
var isFollowing = true;
var followMe = L.control({position:'topright'});
followMe.onAdd = function(map){
  var div = L.DomUtil.create('div', 'leaflet-control-follow');
  div.innerHTML = '📍 Volg mij';
  L.DomEvent.disableClickPropagation(div);
  L.DomEvent.on(div, 'click', function(e){
    L.DomEvent.stopPropagation(e);
    L.DomEvent.preventDefault(e);
    isFollowing = !isFollowing;
    div.style.background = isFollowing ? '#ff6600' : '#555';
    if(isFollowing && userMarker){
      map.flyTo(userMarker.getLatLng(), followZoom, {animate:true, duration:0.8});
    }
  });
  return div;
};
followMe.addTo(map);

// --- Reset functie ---
function resetHuizen(){
  [1,2,3].forEach(id => localStorage.removeItem('huis_'+id));
  alert("Huizen gereset!");
  location.reload(); // Herlaad veilig zodat alle icons correct geladen worden
}

// --- Locatie volgen ---
map.locate({setView:false, watch:true, enableHighAccuracy:true});
var firstFix = true;

function onLocationFound(e){
  var latlng = e.latlng;

  if(!userMarker){
    userMarker = L.marker(latlng, {icon:userIcon}).addTo(map).bindPopup("Jij bent hier!");
  } else {
    userMarker.setLatLng(latlng);
  }

  userCircle.setLatLng(latlng);

  // Eerste GPS fix altijd flyTo met zoom
  if(firstFix){
    map.flyTo(latlng, followZoom, {animate:true, duration:0.8});
    firstFix = false;
  } else if(isFollowing){
    map.flyTo(latlng, followZoom, {animate:true, duration:0.8});
  }

  // Huizen check
  huizen.forEach(function(huis){
    var afstand = map.distance(latlng, [huis.lat, huis.lon]);
    var markerEl = huis.marker.getElement();
    if(!markerEl) return;
    var visited = localStorage.getItem('huis_'+huis.id) === 'true';

    if(afstand < withinRadiusMeters && !visited){
      markerEl.classList.add('pulse-icon');
      localStorage.setItem('huis_'+huis.id, 'true');
      huis.marker.setIcon(halloweenVisitedIcon);
      markerEl.classList.remove('pulse-icon');
    } else {
      markerEl.classList.remove('pulse-icon');
      huis.marker.setIcon(visited ? halloweenVisitedIcon : halloweenActiveIcon);
    }
  });
}

function onLocationError(e){
  alert("Kan je locatie niet vinden: " + e.message);
}

map.on('locationfound', onLocationFound);
map.on('locationerror', onLocationError);
</script>
</body>
</html>
